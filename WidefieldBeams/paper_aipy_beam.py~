import numpy as np
import aipy as a
import healpy as hp
from bm_prms import prms

freqs = [0.150] #np.arange(0.115,0.190,0.005)#0.150
nside = 256
npix = hp.nside2npix(nside)

for freq in freqs:
    bm = prms['beam'](np.array([freq]),nside=nside,lmax=20,mmax=20,deg=7)
    bm.set_params(prms['bm_prms'])
    px = range(hp.nside2npix(nside))
    xyz = hp.pix2vec(nside,px)
    poly = np.array([h.map[px] for h in bm.hmap])
    Axx = np.polyval(poly,freq)
    Axx = np.where(xyz[-1] >= 0, Axx, 0)
    Axx /= Axx.max()
    Axx = Axx*Axx

def aipy_beam(freq,theta,phi):
    # really only defined between 120 and 180 MHz
    # theta, phi in radians
    nside = 256
    bm = prms['beam'](np.array([freq]),nside=nside,lmax=20,mmax=20,deg=7)
    bm.set_params(prms['bm_prms'])
    px = hp.ang2pix(nside,theta,phi)
    xyz = hp.pix2vec(nside,px)
    poly = np.array([h.map[px] for h in bm.hmap])
    Axx = np.polyval(poly,freq)
    Axx = np.where(xyz[-1] >= 0, Axx, 0)
    Axx /= Axx.max()
    Axx = Axx*Axx
    return Axx
    


